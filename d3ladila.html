<!doctype html>
<html>
<head>
    <style>
        svg {
            width: 500px;
            height: 500px
        }

        button {
            float: left
        }

        .line {
            stroke: red;
            stroke-width: 3;
        }

        text {
            font-size: 40px;
            font-family: Helvetica;
            fill: white;

            text-anchor: middle;
            text-align: center;
        }

        circle {
            fill: blue;
            stroke: orange;
            fill-opacity: 0.5;
        }

        .axis line {
            fill: none;
            stroke: #ddd;
            shape-rendering: crispEdges;
        }

        .axis path {
            fill: none;
        }

        .axis text {
            font-size: 0.7em;
            fill: #555;
            font-family: sans-serif
        }
    </style>
    <script src="https://d3js.org/d3.v4.js"></script>
</head>
<body>
<script>


    const unitsData = [
        {
            id: 'a',
            x: 200,
            y: 200,
            size: 20
        },
        {
            id: 'b',
            x: 200,
            y: 400,
            size: 20
        }
    ];

    const outputNode = [{
        id:'output',
        x: 700,
        y: 300,
        size: 40
    }]

    const gateData = [{
        id: "mult1",
        size: 40,
        x: 400,
        y: 300,
        calcSize(connectors = unitsData){
            this.size = connectors.reduce( (acc, val) => acc + val.size, 0)
        }
    }]

    const lineFn = d3.line()
        .x(function (d) {
            return d.x;
        })
        .y(function (d) {
            return d.y;
        })
        .curve(d3.curveLinear);


    //TODO classes that go in arrays...with


    //GateMaker factory
    //Node maker



    //1)create Slides
    //2) attach to dom
    //3) add eventlisteners

    const l = unitsData //TODO replace with simple node drag to change value
        .map(createSlider)
        .map(e => document.body.appendChild(e))

    function createSlider(node) { //TODO replace with action done UNTO element itself
        const sl = document.createElement('input')
        sl.setAttribute('type', 'range')
        sl.setAttribute('class', 'slider')
        sl.style.position = 'absolute'
        sl.style.left = node.x + 'px'
        sl.style.top = node.y + 'px'
        sl.setAttribute('id', node.id)
        sl.addEventListener('input', function () {
            node.size = +sl.value / 5
            console.log(node.size)
            updateNodeFromSlider(node, sl)
            gateData[0].calcSize(unitsData)
        })
        console.log(sl)
        return sl
    }

    var svg = d3.select('body')
        .append('svg');

    svg.style('width', window.innerWidth * 0.9).style('height', window.innerHeight * 0.9); //style instead of attr


    let nodesG = svg.selectAll('gr')
        .data(unitsData)
        .enter().append('g')
            .attr('transform', d => `translate(${d.x}, ${d.y})`);

    const nodes = nodesG.append('circle')
            .attr('r', d => +d.size)
            .attr('id', d => 'circle_' + d.id)

    let textNode = nodesG.append('text')
        .attr("dy", ".35em")
        .classed('text', true)
        .html(d => d.size || "A")



    const outputG = svg.selectAll('.output').data(outputNode)
        .enter().append('g')
        .attr('transform', (d,i) => `translate(${d.x}, ${d.y})`) //-- g doesn't do x, y coords...translate needed
        //NOW ALL CHILDREN ARE POSITIONED RELATIVE --- NO NEED TO SET ABSOLUTE VALUES

    outputG.append('rect')
        .attr('width', d => d.size)
        .attr('height', d => d.size)

    outputG.append('text')
        .attr("dy", ".35em")
        .text("output")


    const gates = svg.selectAll('.gates').data(gateData)
        .enter().append('g')
        .attr('transform', d => `translate(${d.x}, ${d.y})`)


    const rect = gates.append('rect')
        .attr('width', d => d.size)
        .attr('height', d => d.size)


    const text = gates.append("text") //TODO text always latest to be over other elems
        .attr("dy", d=> d.size/1.5 + "px")
        .attr("dx", d=> d.size/2 + "px")
        .classed('text', true)
        .text("+")


    function update(){
        outputG.select('rect').attr('height', d => d.size)
        textNode.html(d => Math.round(d.size));
        console.log(textNode.enter())
    }

    const path1 = svg.selectAll('.line').data(unitsData).enter()
        .append('path')
        .attr("d", d => lineFn([d, gateData[0]]))
        .classed('line', true)

    const path2 = svg.selectAll('.line2').data(gateData).enter()
        .append('path')
        .attr('d', d => lineFn([d,outputNode[0]]))
        .classed('line', true)

    update();

    function updateNodeFromSlider(node) { //only update the
        d3.selectAll(`#circle_${node.id}`)
            .attr("r", node.size * 2)

        update();

    }


</script>
</html>